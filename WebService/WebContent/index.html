<!DOCTYPE html>
<html>
<head>

<title>Insert title here</title>
<style>
.contextmenu{
  visibility:hidden;
  background:#ffffff;
  border:1px solid #8888FF;
  z-index: 10;
  position: relative;
  width: 140px;
}
.contextmenu div{
padding-left: 5px;
font-size:14px;
}
</style>
<link href="css/jqvmap.css" media="screen" rel="stylesheet" type="text/css" />
<link href="js/jquery-window/css/jquery.window.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/json.js"></script>
<script type="text/javascript" src="js/jquery.vmap.js"></script>
<script type="text/javascript" src="js/jquery.vmap.usa.js"></script>
<link href="js/jquery-ui/css/ui-darkness/jquery-ui-1.10.0.custom.css" rel="stylesheet"/>
<script src="js/jquery-ui/js/jquery-ui-1.10.0.custom.js"></script>
<script src="js/chart/highcharts.js"></script>
<script src="js/jquery-window/jquery.window.js"></script>
<script src="js/chart/modules/exporting.js"></script>
<script type="text/javascript" src="http://oauth.googlecode.com/svn/code/javascript/oauth.js"></script>
<script type="text/javascript" src="http://oauth.googlecode.com/svn/code/javascript/sha1.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1WS5oZil_6A-DiEbHeyPnGI5IC-3_Eto&sensor=false">
    </script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>


<script type="text/javascript">
   // var url='http://www.zillow.com/webservice/GetRegionChildren.htm';
   
   var countyWIN=null;
    $(function() {
    	//$.post("/WebService/ajax",{url:convert(url)},function(data){}); 
    	
    	
    	
    	
    	//USA MAP
    	jQuery('#vmap').vectorMap({
		    map: 'usa_en',
		    enableZoom: true,
		    showTooltip: true,
		    selectedRegion: 'MO',
		    onRegionClick: function(element, code, region)
		        {
		            
		                 
		            codeAddress(region);
		            var url="http://api.census.gov/data/2010/sf1?key=219b7e472bceaa9e85d81214fc0f18d54e6f8def&get=NAME&for=state:*"
		            
		           $.post("/WebService/ajax",{url:convert(url)},function(data){
		        	   var stateNum;  	
		            	for(var index in data){
		            		var sname=data[index][0];
		            		if(sname==region){
		            			stateNum=data[index][1];
		            			break;
		            		}
		            	}
		            	data=null;
		            	s=null;
		            	
		            	 var url2="http://api.census.gov/data/2010/sf1?key=219b7e472bceaa9e85d81214fc0f18d54e6f8def&get=NAME&for=county:*&in=state:"+stateNum;
				            $.post("/WebService/ajax",{url:convert(url2)},function(data1){
				            	
				            	
				            	var county="";
				            	for(var index1 in data1){
				            		if(index1>0){
					            		
					            		county=county+"<li><a href=\"javascript:report('&for=county:"+data1[index1][2]+"&in=state:"+data1[index1][1]+"','"+data1[index1][0]+" ,"+code+"');\">"+data1[index1][0]+"</a></li>";
				            		}
				            	}
				            	$("#county").html("");
				            	$("#county").html(county);
				            	if(countyWIN==null){
				            		countyWIN=$.window({
					      	 		   icon: "http://www.fstoke.me/favicon.ico",
					      	 		   title: "Professional JavaScript for Web Developers",
					      	 		   content: $("#countyContainer").html(),
					      	 		   x:0,
					      	 		   y:0,
					      	 		onClose: function(wnd) {
					      	 			countyWIN=null;
					      	         }
					      	 		});
					            	
				            	}else{
				            		countyWIN.setContent($("#countyContainer").html());
				            		countyWIN.show();
				            	}
				            },'json');
		            	
		            },'json');
		           
		        }
		});
    	initialize();
    	
    	
    	
    });
    //finish onload
 		function report(url,address){
 			codeAddress(address);
 			var nurl="http://api.census.gov/data/2010/sf1?key=219b7e472bceaa9e85d81214fc0f18d54e6f8def&get=H011A0002,H011A0003,H011A0004,H011B0002,H011B0003,H011B0004,H011C0002,H011C0003,H011C0004,H011D0002,H011D0003,H011D0004,H011E0002,H011E0003,H011E0004,H011F0002,H011F0003,H011F0004"+url;
 			$.post("/WebService/ajax",{url:nurl},function(data){
 			var mortage=[];
 			var clean=[];
 			var rent=[];
			var nums;
 			for(var i=1;i<=18;i++){
 				nums=parseInt(data[1][i-1]);
 				if((i)%3==1){
 					mortage.push(nums);
 				}
 				if((i)%6==2){
 					clean.push(nums);
 				}
 				if((i)%6==0){
 					rent.push(nums);
 				}
 			}
 			
 			var	chart = new Highcharts.Chart({
 		            chart: {
 		                renderTo: 'container',
 		                type: 'bar'
 		            },
 		            title: {
 		                text: 'Census'
 		            },
 		            xAxis: {
 		                categories: ['WHITE', 'BLACK OR AFRICAN AMERICAN', 'AMERICAN INDIAN AND ALASKA NATIVE', 'ASIAN', 'NATIVE HAWAIIAN AND OTHER PACIFIC ISLANDER','SOME OTHER RACE']
 		            },
 		            yAxis: {
 		                min: 0,
 		                title: {
 		                    text: 'Population'
 		                }
 		            },
 		            legend: {
 		                backgroundColor: '#FFFFFF',
 		                reversed: true
 		            },
 		            tooltip: {
 		                formatter: function() {
 		                    return ''+
 		                        this.series.name +': '+ this.y +'';
 		                }
 		            },
 		            plotOptions: {
 		                series: {
 		                    stacking: 'normal'
 		                }
 		            },
 		                series: [{
 		                name: 'Mortage',
 		                data: mortage
 		            }, {
 		                name: 'Clean',
 		                data: clean
 		            }, {
 		                name: 'Rent',
 		                data: rent
 		            }]
 		        });
 				
 			},'json');
 		}
        function convert(url)
        {
        	//url.replace("?","_#");
        	//url.replace("&","@#");
        	return url;
        }
        
        
        //Google MAP
        var geocoder;
  var map,places;
  function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var mapOptions = {
      zoom: 12,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    places = new google.maps.places.PlacesService(map);
    google.maps.event.addListener(map, "rightclick",function(event){showContextMenu(event.latLng);});
    google.maps.event.addListener(map, "click",function(event){$('.contextmenu').remove();});
  }
  
  function getCanvasXY(caurrentLatLng){
      var scale = Math.pow(2, map.getZoom());
     var nw = new google.maps.LatLng(
         map.getBounds().getNorthEast().lat(),
         map.getBounds().getSouthWest().lng()
     );
     var worldCoordinateNW = map.getProjection().fromLatLngToPoint(nw);
     var worldCoordinate = map.getProjection().fromLatLngToPoint(caurrentLatLng);
     var caurrentLatLngOffset = new google.maps.Point(
         Math.floor((worldCoordinate.x - worldCoordinateNW.x) * scale),
         Math.floor((worldCoordinate.y - worldCoordinateNW.y) * scale)
     );
     return caurrentLatLngOffset;
  }
  function setMenuXY(caurrentLatLng){
    var mapWidth = $('#map_canvas').width();
    var mapHeight = $('#map_canvas').height();
    var menuWidth = $('.contextmenu').width();
    var menuHeight = $('.contextmenu').height();
    var clickedPosition = getCanvasXY(caurrentLatLng);
    var x = clickedPosition.x ;
    var y = clickedPosition.y ;

     if((mapWidth - x ) < menuWidth)
         x = x - menuWidth;
    if((mapHeight - y ) < menuHeight)
        y = y - menuHeight;

    $('.contextmenu').css('left',x  );
    $('.contextmenu').css('top',y );
    }
  
  
  function showContextMenu(caurrentLatLng  ) {
      var projection;
      var contextmenuDir;
      projection = map.getProjection() ;
      $('.contextmenu').remove();
          contextmenuDir = document.createElement("div");
        contextmenuDir.className  = 'contextmenu';
        contextmenuDir.innerHTML = "<a id='menu1'><div class=context><a href='javascript:whatshere("+caurrentLatLng.Ya+","+caurrentLatLng.Za+");'>Where is here?</a><\/div><\/a><a id='menu2'><div class=context><a href='javascript:getLocalBusiness("+caurrentLatLng.Ya+","+caurrentLatLng.Za+");'>Show local real estate</a><\/div><\/a>";
      $(map.getDiv()).append(contextmenuDir);
      
      setMenuXY(caurrentLatLng);

      contextmenuDir.style.visibility = "visible";
     }

  function codeAddress(address) {
    
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
       
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }
  function whatshere(lot,lat){
	  var url="http://maps.googleapis.com/maps/api/geocode/json?latlng="+lot+","+lat+"&sensor=true";
      $.post("/WebService/ajax",{url:convert(url)},function(data1){
    	  var result=(data1.results)[0],address=(result.address_components)[2];
    	  var place=address.long_name;
    	  alert(place);
    	  
      },'json');
  }
  var auth = { 
		  //
		  // Update with your auth tokens.
		  //
		  consumerKey: "de0WNr5Rp0TZKJewwXItaA", 
		  consumerSecret: "q-KAC3B3igYeqsNUwN13MwCfy8I",
		  accessToken: "LcYbZJBd1D3Bwtj6wWrCkuzaeaQyk58i",
		  // This example is a proof of concept, for how to use the Yelp v2 API with javascript.
		  // You wouldn't actually want to expose your access token secret like this in a real application.
		  accessTokenSecret: "hjlo0tEdeye7fijmEfDHaUQYHMw",
		  serviceProvider: { 
		    signatureMethod: "HMAC-SHA1"
		  }
		};
  var yelpMarkerImage = {		  
		  size: new google.maps.Size(25, 31),
		  origin: new google.maps.Point(0, 0),
		  anchor: new google.maps.Point(12, 30),
		  url:"img/yelpMarker.png"
		};
  var yelpMarker=[];
  var yelpTipWin=null;
  function getLocalBusiness(lot,lat){
	  
    	  
    	  parameters = [];
    	  parameters.push(['term', 'restaurant']);
    	  parameters.push(['ll', lot+","+lat]);
    	  parameters.push(['sort', 1]);
    	  parameters.push(['callback', 'cb']);
    	  parameters.push(['oauth_consumer_key', auth.consumerKey]);
    	  parameters.push(['oauth_consumer_secret', auth.consumerSecret]);
    	  parameters.push(['oauth_token', auth.accessToken]);
    	  parameters.push(['oauth_signature_method', 'HMAC-SHA1']);
    	  var message = { 
    			  'action': 'http://api.yelp.com/v2/search',
    			  'method': 'GET',
    			  'parameters': parameters 
    			};
    	  var accessor = {
    			  consumerSecret: auth.consumerSecret,
    			  tokenSecret: auth.accessTokenSecret
    			};
    	  OAuth.setTimestampAndNonce(message);
    	  OAuth.SignatureMethod.sign(message, accessor);

    	  var parameterMap = OAuth.getParameterMap(message.parameters);
    	  parameterMap.oauth_signature = OAuth.percentEncode(parameterMap.oauth_signature);
    	  
    	 
    	  $.ajax({
    		  'url': message.action,
    		  'data': parameterMap,
    		  'cache': true,
    		  'dataType': 'jsonp',
    		  'jsonpCallback': 'cb',
    		  'success': function(data, textStats, XMLHttpRequest) {
    		    var business=data.businesses;
    		    for(var i=0;i<business.length;i++){
    		    	var b=business[i];
    		    	var loc=b.location.coordinate;
    		    	yelpMarker[i]=new google.maps.Marker({
    		              position:new google.maps.LatLng(parseFloat(loc.latitude),parseFloat(loc.longitude)),
    		              animation: google.maps.Animation.DROP,
    		              map: map,
    		              icon:yelpMarkerImage
    		            });
    		    	google.maps.event.addListener(yelpMarker[i], 'click', getYelpDetails(b.name, yelpMarker[i]));
    		    }
    			 
    		  }
    		});
    
     
  }
  function getYelpDetails(content,marker) {
	  return function() {
	  if (yelpTipWin!=null) {
		  yelpTipWin.close();
		  yelpTipWin = null;
        }

        	yelpTipWin = new google.maps.InfoWindow({
            content: "<div>"+content+"</div>"
          });
        	yelpTipWin.open(map, marker);
        
	  }
    }
  var markers = new Array();
  var circle=new Array();
  for(var i=0;i<5;i++){
	  markers[i]=new Array();
	  circle[i]=new Array();
  }
  var color=["133CAB","D1006A","00CB00","A001A5","FF0000"];
  var icon=["deepBlue.png","pink.png","deepgreen.png","purple.png","red.png"];
  var index=-1;
  var flagimage = {		  
		  size: new google.maps.Size(25, 60),
		  origin: new google.maps.Point(0, 0),
		  anchor: new google.maps.Point(3, 57),
		};

  function search() {
	  index++;
	  var keywords=$("#keywordsInput").val();
	  var radius=parseInt($("#radiusInput").val());
      var search = {
    	key:"AIzaSyA9wYURB1vV7LhTmatcZfva240mj6gPHpk",
    	query:keywords,
        bounds: map.getBounds()
      };
     
      places.textSearch(search, function(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
        	var letteredIcon = flagimage;
        	  letteredIcon.url = "img/" + icon[index];
          for (var i = 0; i < results.length; i++) {
            markers[index][i] = new google.maps.Marker({
              position: results[i].geometry.location,
              animation: google.maps.Animation.DROP,
              map: map,
              icon:letteredIcon
            });
            var markercircle = {
            	      strokeColor: color[index],
            	      strokeOpacity: 0.5,
            	      strokeWeight: 2,
            	      fillColor: color[index],
            	      fillOpacity: 0.25,
            	      map: map,
            	      center: results[i].geometry.location,
            	      radius: radius
            	    };
            circle[index][i] = new google.maps.Circle(markercircle);
            google.maps.event.addListener(circle[index][i], "rightclick",function(event){showContextMenu(event.latLng);});
            google.maps.event.addListener(circle[index][i], "click",function(event){$('.contextmenu').remove();});
           // google.maps.event.addListener(markers[i], 'click', getDetails(results[i], i));
        	
          }
        }
        
      });
    }

  function getDetails(result, i) {
      return function() {
        places.getDetails({
          reference: result.reference
        }, showInfoWindow(i));
      }
    }

    function showInfoWindow(i) {
      return function(place, status) {
        if (iw) {
          iw.close();
          iw = null;
        }

        if (status == google.maps.places.PlacesServiceStatus.OK) {
          iw = new google.maps.InfoWindow({
            content: getIWContent(place)
          });
          iw.open(map, markers[i]);
        }
      }
    }

    function getIWContent(place) {
      var content = '<table style="border:0"><tr><td style="border:0;">';
      content += '<img class="placeIcon" src="' + place.icon + '"></td>';
      content += '<td style="border:0;"><b><a href="' + place.url + '">' + place.name + '</a></b>';
      content += '</td></tr></table>';
      return content;
    }
       
</script>
</head>
<body>

<div id="countyContainer" style="display:none;">
<ol id="county"></ol>
</div>
<div style="width:1200px;">
<div id="vmap" style="width: 600px; height: 400px;float:left;"></div>
<div id="map_canvas" style="width: 600px; height: 400px;float:left;"></div>

<div style="float:left;">
<script type="text/javascript" src="//www.google.com/trends/embed.js?hl=en-US&q=Chinese+restaurant,+&geo=US&cmpt=q&content=1&cid=TIMESERIES_GRAPH_0&export=5&w=500&h=330"></script>
<script type="text/javascript" src="//www.google.com/trends/embed.js?hl=en-US&q=Chinese+restaurant,+&geo=US&cmpt=q&content=1&cid=GEO_MAP_0_0&export=5&w=500&h=530"></script>
<script type="text/javascript" src="//www.google.com/trends/embed.js?hl=en-US&q=Chinese+restaurant,+&geo=US&cmpt=q&content=1&cid=TOP_QUERIES_0_0&export=5&w=300&h=420"></script>
<input type="text" id="keywordsInput" /><input type="text" id="radiusInput" /><input type="button" value="add" onClick="search()"/>
</div>
<div id="container" style="min-width: 400px; height: 400px; margin: 0 auto;width:1200px;"></div>

</div>
<div>

</div>
</body>
</html>